# 微信云开发环境创建指南

## 为什么需要创建云开发环境？

微信小程序的云开发功能需要在微信开发者工具中创建云开发环境。环境创建后，你会获得一个唯一的环境ID（格式如：`cloud1-xxxxxxxxxxxxx`），这个ID用于：
- 部署云函数
- 访问云数据库
- 使用云存储
- 在小程序中初始化云开发

## 创建步骤

### 方法一：在微信开发者工具中创建（推荐）

1. **打开微信开发者工具**
   - 打开你的小程序项目
   - 确保已登录微信开发者账号

2. **打开云开发控制台**
   - 点击工具栏上的"云开发"按钮（或使用快捷键）
   - 或者：点击菜单栏 `工具` → `云开发`

3. **创建云开发环境**
   - 如果是第一次使用，会看到"开通云开发"的提示
   - 点击"开通"或"创建环境"
   - 填写环境信息：
     - **环境名称**：自定义名称（如：`生产环境`、`开发环境`）
     - **环境ID**：系统自动生成（格式：`cloud1-xxxxxxxxxxxxx`）
     - **套餐选择**：选择适合的套餐（免费版或付费版）

4. **记录环境ID**
   - 创建成功后，在云开发控制台的顶部可以看到环境ID
   - **重要**：复制这个环境ID，后续需要配置到项目中

5. **更新项目配置**
   创建环境后，需要更新以下文件中的环境ID：

   - `scripts/deploy-cloudfunctions.js`（第14行）
   ```javascript
   const CLOUD_ENV_ID = '你的环境ID'  // 替换这里
   ```

   - `cloudfunctions/cloudbaserc.json`（第2行）
   ```json
   {
     "envId": "你的环境ID",  // 替换这里
     ...
   }
   ```

   - `src/client/cloud.ts`（第7行）
   ```typescript
   const CLOUD_ENV_ID = '你的环境ID'  // 替换这里
   ```

   - `.env` 文件（如果存在）
   ```env
   TARO_APP_CLOUD_ENV=你的环境ID  # 替换这里
   ```

### 方法二：通过 CloudBase CLI 创建（如果支持）

> **注意**：微信小程序的云开发环境通常需要在微信开发者工具中创建。CLI 主要用于管理已存在的环境。

如果 CLI 支持创建环境，可以尝试：

```bash
# 登录 CloudBase CLI
cloudbase login

# 创建新环境（如果支持）
cloudbase env:create <环境名称>
```

但通常建议使用方法一（微信开发者工具）。

## 验证环境创建

创建环境后，可以通过以下方式验证：

### 1. 在微信开发者工具中查看
- 打开云开发控制台
- 查看顶部显示的环境ID
- 确认环境状态为"正常"

### 2. 通过 CLI 查看环境列表
```bash
cloudbase env:list
```

应该能看到你刚创建的环境。

### 3. 检查环境配置
```bash
# 查看当前环境信息
cloudbase env:info
```

## 常见问题

### Q1: 提示"环境不存在"
**原因**：环境ID配置错误，或环境确实不存在

**解决**：
1. 在微信开发者工具中确认环境ID
2. 更新所有配置文件中的环境ID
3. 确保环境状态为"正常"

### Q2: 无法创建环境
**原因**：
- 未登录微信开发者账号
- 账号未认证
- 已达到环境数量限制

**解决**：
1. 确保已登录微信开发者工具
2. 检查账号认证状态
3. 删除不需要的环境（每个账号最多可创建多个环境）

### Q3: 环境ID在哪里查看？
**位置**：
1. 微信开发者工具 → 云开发控制台 → 顶部显示
2. 云开发控制台 → 设置 → 环境设置

### Q4: 可以创建多个环境吗？
**可以**。建议创建：
- **开发环境**：用于开发测试
- **生产环境**：用于正式发布

不同环境的数据和云函数是隔离的。

### Q5: 如何添加新的云开发环境？

#### 方法一：在微信开发者工具中创建（推荐）

1. **打开微信开发者工具**
   - 打开你的小程序项目
   - 确保已登录微信开发者账号

2. **进入云开发控制台**
   - 点击工具栏上的"云开发"按钮
   - 或：菜单栏 `工具` → `云开发`

3. **创建新环境**
   - 在云开发控制台顶部，点击"环境"下拉菜单
   - 选择"创建新环境"或点击"+"按钮
   - 填写环境信息：
     - **环境名称**：自定义名称（如：`test`、`staging`、`production`）
     - **环境ID**：系统自动生成（格式：`环境名-xxxxxxxxxxxxx`）
     - **套餐选择**：选择适合的套餐
   - 点击"创建"或"确认"

4. **记录新环境ID**
   - 创建成功后，在云开发控制台顶部可以看到新环境
   - 复制新环境的环境ID

5. **更新项目配置**
   创建新环境后，需要更新以下文件中的环境ID：

   - `scripts/deploy-cloudfunctions.js`（第14行）
   ```javascript
   const CLOUD_ENV_ID = '新环境ID'  // 替换这里
   ```

   - `cloudfunctions/cloudbaserc.json`（第2行）
   ```json
   {
     "envId": "新环境ID",  // 替换这里
     ...
   }
   ```

   - `src/client/cloud.ts`（第7行）
   ```typescript
   const CLOUD_ENV_ID = '新环境ID'  // 替换这里
   ```

   - `.env` 文件（如果存在）
   ```env
   TARO_APP_CLOUD_ENV=新环境ID  # 替换这里
   ```

6. **部署云函数到新环境**
   ```bash
   npm run deploy:cloudfunctions
   ```

#### 方法二：通过 CloudBase CLI 查看环境

虽然 CLI 可能不支持直接创建环境（环境通常在微信开发者工具中创建），但可以查看：

```bash
# 查看所有环境
cloudbase env:list
# 或使用新命令
tcb env list

# 查看环境详情
cloudbase env:info -e <环境ID>
```

#### 注意事项

- 每个微信开发者账号可创建的环境数量有限（通常为 2-5 个）
- 不同环境的数据、云函数、存储完全隔离
- 建议为不同用途创建不同环境：
  - **开发环境**：日常开发测试
  - **测试环境**：功能测试
  - **生产环境**：正式发布
- 创建新环境后，需要重新部署所有云函数
- 需要在新环境中重新创建数据库集合和配置权限

## 下一步

环境创建完成后：

1. ✅ 更新项目配置文件中的环境ID
2. ✅ 部署云函数：`npm run deploy:cloudfunctions`
3. ✅ 创建云数据库集合（参考 `docs/cloud-migration.md`）
4. ✅ 配置数据库权限
5. ✅ 测试云函数调用

## 相关文档

- [云开发迁移指南](./cloud-migration.md)
- [云函数部署指南](../cloudfunctions/DEPLOY.md)
- [微信云开发官方文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)

