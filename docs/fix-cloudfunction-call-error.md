# 解决云函数调用失败问题

## 错误信息

```
调用云函数 wechatLogin 失败: Error: 云函数调用失败
```

## 问题原因

这个错误通常发生在以下情况：

1. **云函数未部署** - 最常见的原因
2. **云函数部署失败**
3. **云函数代码有错误**
4. **云函数返回格式不正确**
5. **数据库集合未创建**

## 解决步骤

### 第一步：检查云函数是否已部署

1. **打开微信开发者工具**
   - 打开你的小程序项目
   - 点击工具栏上的"云开发"按钮

2. **查看云函数列表**
   - 在云开发控制台中，点击"云函数"标签
   - 查看是否有 `wechatLogin` 云函数
   - 检查云函数状态是否为"正常"

3. **如果云函数不存在或状态异常**
   - 需要部署云函数（见第二步）

### 第二步：部署云函数

#### 方法一：使用微信开发者工具部署（推荐）

1. **在微信开发者工具中**
   - 在左侧文件树中，找到 `cloudfunctions` 目录
   - 右键点击 `cloudfunctions/wechatLogin` 目录
   - 选择 **"上传并部署：云端安装依赖"**
   - 等待部署完成（会显示部署进度）

2. **验证部署**
   - 在云开发控制台的"云函数"页面
   - 确认 `wechatLogin` 云函数状态为"正常"
   - 可以点击云函数名称查看详情

#### 方法二：使用 CLI 部署

```bash
# 进入云函数目录
cd cloudfunctions/wechatLogin

# 安装依赖
npm install

# 然后在微信开发者工具中右键上传部署
```

### 第三步：检查数据库集合

云函数 `wechatLogin` 需要使用 `profiles` 集合，需要先创建：

1. **打开云开发控制台**
   - 点击"数据库"标签

2. **创建集合**
   - 点击"添加集合"
   - 集合名称：`profiles`
   - 权限设置：选择"仅创建者可读写"（或根据需要设置）
   - 点击"确定"

3. **验证集合**
   - 确认 `profiles` 集合已创建
   - 可以查看集合的字段结构

### 第四步：检查云函数日志

如果云函数已部署但仍然失败，查看日志：

1. **在云开发控制台**
   - 点击"云函数"标签
   - 点击 `wechatLogin` 云函数名称
   - 查看"调用日志"或"错误日志"

2. **常见错误**
   - `collection not found` - 数据库集合未创建
   - `permission denied` - 数据库权限设置错误
   - `syntax error` - 云函数代码有语法错误

### 第五步：重新编译和测试

1. **重新编译项目**
   ```bash
   npm run dev:weapp
   ```
   或在微信开发者工具中点击"编译"按钮

2. **查看控制台日志**
   - 打开微信开发者工具的"调试器"
   - 查看控制台输出
   - 现在会显示更详细的错误信息：
     - `📞 调用云函数: wechatLogin` - 调用开始
     - `📥 云函数 wechatLogin 响应:` - 响应内容
     - `❌ 云函数 wechatLogin 执行失败:` - 错误详情

3. **根据错误信息排查**
   - 如果显示"云函数未找到"，需要部署云函数
   - 如果显示"数据库集合不存在"，需要创建集合
   - 如果显示其他错误，查看云函数日志

## 常见问题

### Q1: 云函数部署失败

**可能原因**：
- 网络问题
- 依赖安装失败
- 代码语法错误

**解决**：
1. 检查网络连接
2. 查看部署日志中的错误信息
3. 检查 `cloudfunctions/wechatLogin/package.json` 是否正确
4. 尝试在云函数目录下手动运行 `npm install`

### Q2: 云函数已部署但调用失败

**可能原因**：
- 数据库集合未创建
- 数据库权限设置错误
- 云函数代码逻辑错误

**解决**：
1. 检查数据库集合是否已创建
2. 查看云函数调用日志
3. 检查云函数代码逻辑

### Q3: 控制台显示"云函数返回格式错误"

**可能原因**：
- 云函数返回的数据格式不正确
- 云函数执行出错但没有正确处理

**解决**：
1. 查看云函数代码的返回格式
2. 检查云函数是否有 try-catch 错误处理
3. 查看云函数日志中的错误信息

### Q4: 如何查看详细的错误信息？

**方法**：
1. 打开微信开发者工具的"调试器"
2. 查看"Console"标签
3. 现在会显示详细的调用日志：
   - 调用参数
   - 响应内容
   - 错误详情

## 验证步骤

完成配置后，按以下步骤验证：

1. **确认云函数已部署**
   - 在云开发控制台查看云函数列表
   - 确认 `wechatLogin` 状态为"正常"

2. **确认数据库集合已创建**
   - 在云开发控制台查看数据库集合
   - 确认 `profiles` 集合存在

3. **重新编译项目**
   ```bash
   npm run dev:weapp
   ```

4. **测试登录功能**
   - 尝试登录
   - 查看控制台日志
   - 确认云函数调用成功

## 相关文档

- [使用微信开发者工具部署云函数](./deploy-via-wechat-tool.md)
- [解决云开发权限错误](./fix-cloud-permission-error.md)
- [云开发环境创建指南](./cloud-env-setup.md)

