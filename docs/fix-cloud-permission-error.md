# 解决云开发权限错误 -601034

## 错误信息

```
errCode: -601034 | errMsg: 没有权限，请先开通云开发或者云托管
```

## 问题原因

这个错误通常发生在以下情况：

1. **微信开发者工具中没有正确配置云开发环境**
2. **小程序项目没有关联到云开发环境**
3. **云开发环境未正确开通或初始化**

## 解决步骤

### 方法一：在微信开发者工具中配置云开发（推荐）

1. **打开微信开发者工具**
   - 打开你的小程序项目
   - 确保已登录微信开发者账号

2. **检查云开发状态**
   - 点击工具栏上的"云开发"按钮
   - 如果看到"开通云开发"提示，点击开通
   - 如果已经开通，确认当前环境为 `cloud1-9gu9ppxt5c82bbc1`

3. **设置云开发环境**
   - 在云开发控制台顶部，确认环境ID为 `cloud1-9gu9ppxt5c82bbc1`
   - 如果显示其他环境，点击环境下拉菜单切换到正确的环境

4. **检查项目配置**
   - 在微信开发者工具中，点击菜单栏 `项目` → `设置`
   - 确认"云开发"选项已勾选
   - 确认"云函数目录"设置为 `cloudfunctions`

5. **重新编译**
   - 点击工具栏上的"编译"按钮
   - 或者使用快捷键 `Ctrl + B` (Windows) / `Cmd + B` (Mac)

### 方法二：检查 project.config.json 配置

确保 `project.config.json` 中包含以下配置：

```json
{
  "cloudfunctionRoot": "cloudfunctions/",
  "cloudbaseRoot": "cloudfunctions/"
}
```

### 方法三：验证云开发初始化

1. **检查控制台日志**
   - 在微信开发者工具中打开"调试器"
   - 查看控制台是否有 "云开发初始化成功" 的日志
   - 如果看到初始化失败的错误，检查环境ID是否正确

2. **手动测试云开发**
   - 在控制台输入以下代码测试：
   ```javascript
   wx.cloud.init({
     env: 'cloud1-9gu9ppxt5c82bbc1',
     traceUser: true
   })
   console.log('云开发初始化:', wx.cloud)
   ```

### 方法四：重新部署云函数

如果云函数还没有部署，需要先部署：

1. 在微信开发者工具中，右键点击 `cloudfunctions/wechatLogin`
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成
4. 重复上述步骤部署其他云函数

## 常见问题

### Q1: 云开发控制台显示"未开通"

**解决**：
1. 点击"开通云开发"
2. 选择套餐（免费版或付费版）
3. 创建环境并记录环境ID

### Q2: 环境ID不匹配

**解决**：
1. 在云开发控制台查看实际的环境ID
2. 更新以下文件中的环境ID：
   - `src/client/cloud.ts` (第7行)
   - `cloudfunctions/cloudbaserc.json` (第2行)
   - `scripts/deploy-cloudfunctions.js` (第14行)

### Q3: 云函数调用失败

**解决**：
1. 确认云函数已部署
2. 在云开发控制台的"云函数"页面查看云函数状态
3. 检查云函数日志，查看具体错误信息

### Q4: 初始化成功但调用失败

**解决**：
1. 检查环境ID是否正确
2. 确认云函数已部署到正确的环境
3. 检查云函数的权限设置

## 验证步骤

完成配置后，按以下步骤验证：

1. **重新编译项目**
   ```bash
   npm run dev:weapp
   ```

2. **在微信开发者工具中运行**
   - 点击"编译"按钮
   - 查看控制台是否有错误

3. **测试云函数调用**
   - 尝试登录功能
   - 查看控制台日志
   - 确认云函数调用成功

## 相关文档

- [云开发环境创建指南](./cloud-env-setup.md)
- [使用微信开发者工具部署云函数](./deploy-via-wechat-tool.md)
- [微信云开发官方文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)

